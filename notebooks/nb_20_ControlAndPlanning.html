

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta property="og:title" content="Introduction" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://aai-institute.github.io/notebooks/nb_20_ControlAndPlanning.html" />
<meta property="og:site_name" content="Python" />
<meta property="og:description" content="In previous sections, we have designed feedback controllers for various systems with the goal of regulating the system output to a desired setpoint. Specifically, we utilized Fullstate Feedback and..." />
<meta property="og:image:width" content="1146" />
<meta property="og:image:height" content="600" />
<meta property="og:image" content="https://aai-institute.github.io/tfl-training-machine-learning-control/_images/social_previews/summary_notebooks_nb_20_ControlAndPlanning_03d55f23.png" />
<meta property="og:image:alt" content="In previous sections, we have designed feedback controllers for various systems with the goal of regulating the system output to a desired setpoint. Specific..." />
<meta name="description" content="In previous sections, we have designed feedback controllers for various systems with the goal of regulating the system output to a desired setpoint. Specifically, we utilized Fullstate Feedback and..." />
<meta name="twitter:card" content="summary_large_image" />

    <title>Introduction &#8212; Machine Learning Control Training</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"loader": {"load": ["[tex]/configmacros"]}, "tex": {"packages": {"[+]": ["configmacros"]}, "macros": {"vect": ["{\\mathbf{\\boldsymbol{#1}} }", 1], "E": "{\\mathbb{E}}", "P": "{\\mathbb{P}}", "R": "{\\mathbb{R}}", "abs": ["{\\left| #1 \\right|}", 1], "simpl": ["{\\Delta^{#1} }", 1], "amax": "{\\text{argmax}}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/nb_20_ControlAndPlanning';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Introduction" href="nb_40_RecentDevelopmentsInControl.html" />
    <link rel="prev" title="Introduction" href="nb_10_Introduction.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="home.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/transferlab-logo.svg" class="logo__image only-light" alt="Machine Learning Control Training - Home"/>
    <script>document.write(`<img src="../_static/transferlab-logo.svg" class="logo__image only-dark" alt="Machine Learning Control Training - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="home.html">
                    Machine Learning Control Training
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebook Pages</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="nb_10_Introduction.html">Introduction</a></li>




<li class="toctree-l1 current active"><a class="current reference internal" href="#">Introduction</a></li>







<li class="toctree-l1"><a class="reference internal" href="nb_40_RecentDevelopmentsInControl.html">Introduction</a></li>






</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Code</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../apidocs/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control.utils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.shortest_path_problem.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control.shortest_path_problem</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.plots.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control.plots</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.environment.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control.environment</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.control.parameters.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.control.parameters</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.constants.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.constants</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidocs/training_ml_control/training_ml_control.nb_utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">training_ml_control.nb_utils</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/aai-institute/tfl-training-machine-learning-control/main?urlpath=tree/notebooks/nb_20_ControlAndPlanning.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/aai-institute/tfl-training-machine-learning-control" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/aai-institute/tfl-training-machine-learning-control/edit/main/notebooks/nb_20_ControlAndPlanning.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/aai-institute/tfl-training-machine-learning-control/issues/new?title=Issue%20on%20page%20%2Fnotebooks/nb_20_ControlAndPlanning.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/nb_20_ControlAndPlanning.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#planning">Planning</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#state-transition-systems">State-Transition Systems</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plans">Plans</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-control">Optimal Control</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-time">Continuous-time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-time">Discrete-time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-horizon">Finite Horizon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#infinite-horizon">Infinite Horizon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-the-cost-function">Choosing the cost function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#systems">Systems</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mass-spring-damper-model">Mass-Spring-Damper Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-space-matrices">State-Space Matrices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-states-and-control-inputs">Model, States and Control inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretization">Discretization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inverted-pendulum-model">Inverted Pendulum Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linearized-model">Linearized Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">State-Space Matrices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Model, States and Control inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#auxiliary-expressions">Auxiliary Expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#model-setup">Model Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Discretization</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-linear-model">Non-Linear Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Model, States and Control inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ode">ODE</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Auxiliary Expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Model Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helpers">Helpers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulators">Simulators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-programming">Dynamic Programming</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dp-algorithm">DP Algorithm</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">Solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-quadratic-regulator">Linear Quadratic Regulator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mass-spring-damper">Mass-Spring-Damper</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">SImulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inverted-pendulum">Inverted Pendulum</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#model-predictive-control">Model Predictive Control</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-linear-quadratic-regulator">Iterative Linear Quadratic Regulator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#differential-dynamic-programming">Differential Dynamic Programming</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Mass-Spring-Damper</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#controller">Controller</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#objective">Objective</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#constraints">Constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#swing-up">Swing-up</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Controller</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Objective</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#mpc-and-alphazero">MPC and AlphaZero</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monte-carlo-tree-search">Monte Carlo Tree Search</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">presentation_style</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>UsageError: Line magic function `%presentation_style` not found.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_latex_macros</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>UsageError: Line magic function `%load_latex_macros` not found.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">autoreload</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="kn">import</span> <span class="nn">casadi</span>
<span class="kn">import</span> <span class="nn">do_mpc</span>
<span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">gymnasium</span> <span class="kn">import</span> <span class="n">Env</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">widgets</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>

<span class="kn">from</span> <span class="nn">training_rl.control</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_inverted_pendulum_environment</span><span class="p">,</span>
    <span class="n">create_mass_spring_damper_environment</span><span class="p">,</span>
    <span class="n">MassSpringDamperParameters</span><span class="p">,</span>
    <span class="n">InvertedPendulumParameters</span><span class="p">,</span>
    <span class="n">plot_inverted_pendulum_results</span><span class="p">,</span>
    <span class="n">create_shortest_path_graph</span><span class="p">,</span>
    <span class="n">plot_shortest_path_graph</span><span class="p">,</span>
    <span class="n">plot_all_paths_graph</span><span class="p">,</span>
    <span class="n">animate_mass_spring_damper_simulation</span><span class="p">,</span>
    <span class="n">animate_inverted_pendulum_simulation</span><span class="p">,</span>
    <span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">,</span>
    <span class="n">display_array</span><span class="p">,</span>
    <span class="n">show_video</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="c1"># This is needed because inside docker the rendering of mujoco environments may not work.</span>
<span class="n">render_mode</span> <span class="o">=</span> <span class="s2">&quot;rgb_array&quot;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DISPLAY&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/code/.venv/lib/python3.11/site-packages/do_mpc/sysid/__init__.py:15: UserWarning: The ONNX feature is not available. Please install the full version of do-mpc to access this feature.
  warnings.warn(&#39;The ONNX feature is not available. Please install the full version of do-mpc to access this feature.&#39;)
/tmp/code/.venv/lib/python3.11/site-packages/do_mpc/opcua/__init__.py:14: UserWarning: The opcua feature is not available. Please install the full version of do-mpc to access this feature.
  warnings.warn(&#39;The opcua feature is not available. Please install the full version of do-mpc to access this feature.&#39;)
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">19</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="ne">---&gt; </span><span class="mi">19</span> <span class="kn">from</span> <span class="nn">training_rl.control</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="n">create_inverted_pendulum_environment</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>     <span class="n">create_mass_spring_damper_environment</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>     <span class="n">MassSpringDamperParameters</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>     <span class="n">InvertedPendulumParameters</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>     <span class="n">plot_inverted_pendulum_results</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">create_shortest_path_graph</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">plot_shortest_path_graph</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="n">plot_all_paths_graph</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="n">animate_mass_spring_damper_simulation</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span>     <span class="n">animate_inverted_pendulum_simulation</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>     <span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>     <span class="n">display_array</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>     <span class="n">show_video</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;training_rl&#39;
</pre></div>
</div>
</div>
</div>
<img src="_static/images/aai-institute-cover.svg" alt="presentation first slide" style="width:100%;">
<div class="md-slide title">Control and Planning</div><section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p>In previous sections, we have designed feedback controllers for various systems with the goal of regulating the system output to a desired setpoint. Specifically, we utilized Fullstate Feedback and PID controllers. While these simple controllers can effectively regulate many systems, they have limitations that prevent high performance control for more complex systems.</p>
<p>First, these controllers have a fixed, static gain that does not change over time. This limits their ability to adapt to changing system dynamics or disturbances. Second, after developing a mathematical model of the system dynamics, we did not actually utilize the model in the controller design. A model-based approach could allow us to leverage our understanding of the system to improve control performance.</p>
<p>One ubiquitous challenge in control system design is the presence of control input constraints. Actuators in physical systems inherently have limits on their amplitude and rate of change. For example, a motor has maximum torque and acceleration limits. If control input constraints are ignored in the controller design, the resulting control inputs may saturate the actuators, degrading closed-loop performance.</p>
<p>There are two main strategies to address control input constraints:</p>
<ul class="simple">
<li><p>Reduce the performance requirements to levels achievable with a linear controller without violating the constraints.</p></li>
<li><p>Directly account for the constraints by modifying the control design and online optimization of the control input.   For example, model predictive control utilizes the system model to predict future behavior and optimize the control input while satisfying constraints.</p></li>
</ul>
<p>In subsequent sections, we will explore model-based and optimization-based control techniques to overcome the limitations of basic controllers. Properly managing control input constraints is crucial to achieving high performance in real control systems.</p>
<div>
<figure style="float: left; width: 60%;">
    <img src="_static/images/30_constrained_motion.png" width="100%"/>
</figure>
<div style="float: right; width: 39%;">
<br><br>Illustration of constrained motion of a car from point A to point B. There are state (position/velocity) constraints, and control (acceleration) constraints. When there are mobile obstacles, the state constraints may change unpredictably, necessitating on-line replanning.
</div>
</div><p>In this part of the training, we will move away from classical control methods and focus on optimal control methods applied to linear and non-linear systems.</p>
<p>We will use the same 2 systems we have studied previously (Mass-Spring-Damper and Inverted Pendulum). We will additionally consider controlling the full non-linear inverted pendulum (pendulum angle and cart position).</p>
<p>As we present the different methods, we will highlight commonalities and differences with Reinforcement Learning.</p>
<p>For the final exercise we will attempt to control the highly non-linear inverted pendulum system with different objectives.</p>
<p>Finally, we will present AlphaZero and highlight</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="planning">
<h1>Planning<a class="headerlink" href="#planning" title="Permalink to this heading">#</a></h1>
<p>Planning refers to the explicit deliberation process that chooses and organizes actions by anticipating their
outcomes with the goal to achieve some pre-stated objectives.</p>
<p>Automated planning and scheduling, sometimes denoted as simply AI planning, is a branch of artificial intelligence that concerns the realization of strategies or action sequences, typically for execution by intelligent agents, autonomous robots and unmanned vehicles. Unlike classical control problems, the solutions are complex and must be discovered and optimized in multidimensional space.</p>
<p>In planning we use a model of the environment/system to predict the effect of taking a certain action in a certain state. Thus it is a <strong>model-based</strong> approach.</p>
<section id="state-transition-systems">
<h2>State-Transition Systems<a class="headerlink" href="#state-transition-systems" title="Permalink to this heading">#</a></h2>
<p>A state-transition system is a 3-tuple <span class="math notranslate nohighlight">\(\Sigma = (S,A,\gamma)\)</span>, where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(S = \{s_1,s_2,\dots\}\)</span> is a finite or recursively enumerable set of states.</p></li>
<li><p><span class="math notranslate nohighlight">\(U = \{u_1,u_2,\dots\}\)</span> is a finite or recursively enumerable set of actions.</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma: S\times U \rightarrow 2^S\)</span> is a state transition function.</p></li>
<li><p>if <span class="math notranslate nohighlight">\(u \in U\)</span> and <span class="math notranslate nohighlight">\(\gamma(s,u) \neq \emptyset\)</span> then <span class="math notranslate nohighlight">\(a\)</span> is applicable in <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p>applying <span class="math notranslate nohighlight">\(u\)</span> in <span class="math notranslate nohighlight">\(s\)</span> will take the system to <span class="math notranslate nohighlight">\(s^{\prime} \in \gamma(s,u).\)</span></p></li>
</ul>
<p>A state-transition system can be represented by a directed labelled graph <span class="math notranslate nohighlight">\(G = (N_G,E_G)\)</span> where:</p>
<ul class="simple">
<li><p>the nodes correspond to the states in <span class="math notranslate nohighlight">\(S\)</span>, i.e. <span class="math notranslate nohighlight">\(N_G = S.\)</span></p></li>
<li><p>there is an arc from <span class="math notranslate nohighlight">\(s \in N_G\)</span> to <span class="math notranslate nohighlight">\(s^\prime \in N_G\)</span>, i.e.<span class="math notranslate nohighlight">\(s \rightarrow s^\prime \in E_G\)</span>, with label <span class="math notranslate nohighlight">\(u \in U\)</span> if and only if <span class="math notranslate nohighlight">\(s^\prime \in \gamma(s,u).\)</span></p></li>
</ul>
</section>
<section id="plans">
<h2>Plans<a class="headerlink" href="#plans" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>a plan <span class="math notranslate nohighlight">\(\pi\)</span> is a finite sequence of actions, <span class="math notranslate nohighlight">\(\pi = \{u_1, \dots, u_n\}\)</span></p></li>
<li><p>a planning problem is a triple <span class="math notranslate nohighlight">\(P = (\Sigma, s_0, S_g)\)</span>, where <span class="math notranslate nohighlight">\(\Sigma\)</span> is a
state-transition system, <span class="math notranslate nohighlight">\(s_0 \in S\)</span> is an initial state, and <span class="math notranslate nohighlight">\(S_g \subset S\)</span> is a set of goal states.</p></li>
<li><p>each node is written as a pair <span class="math notranslate nohighlight">\(v = (\pi, s)\)</span> where <span class="math notranslate nohighlight">\(\pi\)</span> is a plan and <span class="math notranslate nohighlight">\(s = \gamma(s_0, \pi)\)</span></p></li>
</ul>
<div>
<figure style="float: left; width: 30%;">
    <img src="_static/images/30_planning_and_plan_execution.png" width="100%"/>
</figure>
<div style="float: left; width: 60%;">
<ul class="simple">
<li><p>Planner:</p>
<ul>
<li><p>given: description of an environment/system <span class="math notranslate nohighlight">\(\Sigma\)</span>, initial state, and objective.</p></li>
<li><p>generate: plan that achieves objective.</p></li>
</ul>
</li>
<li><p>Controller:</p>
<ul>
<li><p>given: plan, current state (observation function: <span class="math notranslate nohighlight">\(\eta:S \rightarrow O\)</span>)</p></li>
<li><p>generate: action.</p></li>
</ul>
</li>
<li><p>Environment/System:</p>
<ul>
<li><p>evolves as actions are executed and events occur</p></li>
</ul>
</li>
</ul>
</div>
</div></section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="optimal-control">
<h1>Optimal Control<a class="headerlink" href="#optimal-control" title="Permalink to this heading">#</a></h1>
<p>Optimal control theory is a branch of control theory that deals with finding a control for a dynamical system over a period of time such that an objective function is optimized. The fundamental idea in optimal control is to formulate the goal of control as the long-term optimization of a scalar cost function.</p>
<center>
<figure>
    <img src="_static/images/30_optimal_control_problem.png" width="100%"/>
    <figcaption>
        Deterministic N-stage optimal control problem.
    </figcaption>
</figure>
</center><p>The optimal control problem is to find a control <span class="math notranslate nohighlight">\(u^* \in \mathbf{U}\)</span> which causes the system <span class="math notranslate nohighlight">\(\dot{x}(t) = f(x(t), u(t))\)</span> to follow a trajectory <span class="math notranslate nohighlight">\(x^* \in \mathbf{X}\)</span> that minimizes the cost (performance measure):</p>
<section id="continuous-time">
<h2>Continuous-time<a class="headerlink" href="#continuous-time" title="Permalink to this heading">#</a></h2>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\displaystyle  \min_{u} &amp; J(x_0, u) &amp; \text{(cost)}\\
\text{subject to} &amp; \dot{x}(t) = f(x(t), u(t)) &amp; \text{(dynamical feasibility)}\\
&amp; x(T) \in \mathbf{X_T} &amp; \text{(boundary conditions)}\\
&amp; x(t) \in \mathbf{X} , \forall t \in [0, T] &amp; \text{(state constraints)}\\
&amp; u(t) \in \mathbf{U}, \forall t \in [0, T] &amp; \text{(input constraints)}\\
\end{array}
\end{split}\]</div>
</section>
<section id="discrete-time">
<h2>Discrete-time<a class="headerlink" href="#discrete-time" title="Permalink to this heading">#</a></h2>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\displaystyle  \min_{u} &amp; J(x_0, u) &amp; \text{(cost)}\\
\text{subject to} &amp; x_{t+1} = f(x_t, u_t) &amp; \text{(dynamical feasibility)}\\
&amp; x_N \in \mathbf{X_N} &amp; \text{(boundary conditions)}\\
&amp; x_t \in \mathbf{X} , \forall t \in \{0, 1, \dots , N - 1\} &amp; \text{(state constraints)}\\
&amp; u_t \in \mathbf{U}, \forall t \in \{0, 1, \dots , N - 1\} &amp; \text{(input constraints)}\\
\end{array}
\end{split}\]</div>
</section>
<section id="finite-horizon">
<h2>Finite Horizon<a class="headerlink" href="#finite-horizon" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Continuous-time:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[
J_{0}(x_0, u) = g_T(x(T)) + \int \limits_{0}^{T} g(x(t), u(t)) dt
\]</div>
<ul class="simple">
<li><p>Discrete-time:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[
J_0(x_0, u) = g_N(x_N) + \sum \limits_{k = 0}^{N-1} g_k(x_k, u_k)
\]</div>
</section>
<section id="infinite-horizon">
<h2>Infinite Horizon<a class="headerlink" href="#infinite-horizon" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Continuous-time:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[
J(x_0, u) = \int \limits_{0}^{\infty} g(x(t), u(t)) dt
\]</div>
<ul class="simple">
<li><p>Discrete-time:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[
J(x_0, u) = \sum \limits_{k = 0}^{\infty} g_k(x_k, u_k)
\]</div>
<center>
<figure>
    <img src="_static/images/30_transition_graph_discrete_system.png" width="100%"/>
    <figcaption>
        Transition graph for a deterministic discrete system.
    </figcaption>
</figure>
</center><p>This approach is powerful for a number of reasons. First and foremost, it is very general - allowing us to specify the goal of control equally well for fully- or under-actuated, linear or nonlinear, deterministic or stochastic, and continuous or discrete systems. Second, it permits concise descriptions of potentially very complex desired behaviours, specifying the goal of control as a scalar objective (plus a list of constraints).</p>
<p>Optimal control problems solving methods can be classified in three main families:
Dynamic Programming (DP), Indirect Methods based on calculus of variation and Direct Methods.</p>
<ul class="simple">
<li><p>DP is helpful where the number of states is limited and the dynamics are known. It divides an optimal control issue into smaller subproblems and recursively solves each.</p></li>
<li><p>Indirect methods rely on Pontryagins Minimum Principle (PMP) to derive the necessary conditions
for optimality. This method uses the Hamiltonian of the system to reduce the global optimal control problem
to the solution of a system of <span class="math notranslate nohighlight">\(2N\)</span> equations given in the form of a two-point boundary value problem (BVP).<br />
Problems involving continuous states and control inputs benefit most from it.</p></li>
</ul>
<ul>
<li><p>Direct methods rely on the discretization of the original optimal control problem which is then transcribed to
a nonlinear programming problem (NLP) solved numerically using a well-established optimisation method.</p>
<p>There are many direct methods. They differ on how the variables (i.e. control and states) are discretised
and on how the continuous time dynamics is approximated.</p>
<p>In the case of shooting and multiple shooting the control are parameterised
with piecewise linear functions and the differential equations
are solved via numerical integration. These approaches make use of robust
and available ordinary differential equations solvers
but need sensitivity analysis to compute the jacobians
of the continuity and boundary conditions with respect to the initial and intermediate conditions.</p>
<p>In the case of state and control parameterisation (direct collocation),
both states and controls are approximated with polynomial functions,
therefore the continuous time differential equations are converted into algebraic constraints.</p>
</li>
</ul>
<center>
<figure>
    <img src="_static/images/30_optimal_control_methods.svg" width="80%"/>
    <figcaption>
        Classification of different methods to solve optimal control problems and related formulations and
solution algorithms <a id="biral_notes_2016-back" href="#biral_notes_2016">[Biral Notes 2016]</a>.
    </figcaption>
</figure>
</center></section>
<section id="choosing-the-cost-function">
<h2>Choosing the cost function<a class="headerlink" href="#choosing-the-cost-function" title="Permalink to this heading">#</a></h2>
<p>Choosing a cost function means translating the systems desired physical state into a mathematical formulation.</p>
<p>Examples:</p>
<ul class="simple">
<li><p>Minimum-time problems: <span class="math notranslate nohighlight">\(J = t_f - t_0\)</span></p></li>
<li><p>Terminal control problems: <span class="math notranslate nohighlight">\(J = || x(t_f) - r(t_f) ||^2\)</span></p></li>
<li><p>Minimum control-effort problems: <span class="math notranslate nohighlight">\(J = \sum \limits_{k = t_0}^{t_f} |u(t_k)|\)</span></p></li>
</ul>
</section>
<section id="questions">
<h2>Questions<a class="headerlink" href="#questions" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>What are possible cost functions for the 2 systems?</p></li>
</ul>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="systems">
<h1>Systems<a class="headerlink" href="#systems" title="Permalink to this heading">#</a></h1>
<section id="mass-spring-damper-model">
<h2>Mass-Spring-Damper Model<a class="headerlink" href="#mass-spring-damper-model" title="Permalink to this heading">#</a></h2>
<div>
<figure style="float: left; width: 50%;">
    <img src="_static/images/20_mass_spring_damper.svg" width="50%"/>
    <figcaption>
        Classic model used for deriving the equations of a mass spring damper model <a href="#wiki_mass_spring_damper"><b id="wiki_mass_spring_damper-back">[Wiki Mass-Spring-Damper, 2023]</b></a>
    </figcaption>
</figure>
<div style="float: left; width: 40%;">
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(z(t)\)</span>: Distance along the vertical axis from some reference point.</p></li>
<li><p><span class="math notranslate nohighlight">\(m\)</span>: Mass of the object.</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda\)</span>: Coefficient of elasticity.</p></li>
<li><p><span class="math notranslate nohighlight">\(l\)</span>: Length of spring.</p></li>
<li><p><span class="math notranslate nohighlight">\(k = \frac{\lambda}{l}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(c\)</span>: Damping coefficient.</p></li>
<li><p><span class="math notranslate nohighlight">\(f(t)\)</span>: Force applied on the object.</p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma\)</span>: Motors gear factor.</p></li>
<li><p><span class="math notranslate nohighlight">\(g\)</span>: Gravity.</p></li>
</ul>
</div>
</div><p>The system has linear state-space model with matrices:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
A
=
\begin{bmatrix}
0 &amp; 1 \\
-\frac{k}{m} &amp; -\frac{c}{m}\\
\end{bmatrix};
B
=
\begin{bmatrix}
0 \\
\frac{\gamma}{m}\\
\end{bmatrix};
C = \begin{bmatrix}
1 &amp; 0 \\
\end{bmatrix};
D = \begin{bmatrix}
0
\end{bmatrix}
\end{split}\]</div>
<section id="state-space-matrices">
<h3>State-Space Matrices<a class="headerlink" href="#state-space-matrices" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msd_parameters</span> <span class="o">=</span> <span class="n">MassSpringDamperParameters</span><span class="p">()</span>
<span class="c1"># Dynamics matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">msd_parameters</span><span class="o">.</span><span class="n">k</span> <span class="o">/</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="n">msd_parameters</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Input matrix</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">gamma</span> <span class="o">/</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">]])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="c1"># Output matrices</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">msd_parameters</span> <span class="o">=</span> <span class="n">MassSpringDamperParameters</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1"># Dynamics matrix</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="p">[</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="p">[</span><span class="o">-</span><span class="n">msd_parameters</span><span class="o">.</span><span class="n">k</span> <span class="o">/</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="n">msd_parameters</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">msd_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="p">)</span>

<span class="ne">NameError</span>: name &#39;MassSpringDamperParameters&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-states-and-control-inputs">
<h3>Model, States and Control inputs<a class="headerlink" href="#model-states-and-control-inputs" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mass_spring_damper</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">(</span><span class="s2">&quot;continuous&quot;</span><span class="p">)</span>
<span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>
<span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span><span class="p">)</span>
<span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>
<span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;A&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="discretization">
<h3>Discretization<a class="headerlink" href="#discretization" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="n">mass_spring_damper</span> <span class="o">=</span> <span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">discretize</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mass_spring_damper</span> <span class="o">=</span> <span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">discretize</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="inverted-pendulum-model">
<h2>Inverted Pendulum Model<a class="headerlink" href="#inverted-pendulum-model" title="Permalink to this heading">#</a></h2>
<div>
<figure style="float: left; width: 40%;">
    <img src="_static/images/20_inverted_pendulum.svg" width="50%"/>
    <figcaption>
        Inverted pendulum model <a href="#goodwin_control_2000"><b id="goodwin_control_2000-back">[Goodwin et al., 2000]</b></a>
    </figcaption>
</figure>
<div style="float: left; width: 50%;">
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(y(t)\)</span>: distance along the horizontal axis from some reference point.</p></li>
<li><p><span class="math notranslate nohighlight">\(\theta(t)\)</span>: angle of the pendulum.</p></li>
<li><p><span class="math notranslate nohighlight">\(M\)</span>: mass of the cart.</p></li>
<li><p><span class="math notranslate nohighlight">\(m\)</span>: mass of the pendulum (assumed to be concentrated at the tip).</p></li>
<li><p><span class="math notranslate nohighlight">\(l\)</span>: length of the pendulum.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_c\)</span>: cart friction coefficient.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_p\)</span>: pendulum friction coefficient.</p></li>
<li><p><span class="math notranslate nohighlight">\(f(t)\)</span>: force applied on the cart.</p></li>
</ul>
</div>
</div><section id="linearized-model">
<h3>Linearized Model<a class="headerlink" href="#linearized-model" title="Permalink to this heading">#</a></h3>
<p>The system has the following partial (pendulum angle and angular velocity only) linearized (around <span class="math notranslate nohighlight">\(\theta = 0\)</span> and <span class="math notranslate nohighlight">\(\dot{\theta} = 0\)</span>) state space model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
A = \begin{bmatrix}
0 &amp; 1 \\
\frac{(M + m)g}{Ml} &amp; 0\\
\end{bmatrix};
B = \begin{bmatrix}
0 \\ -\frac{\gamma}{Ml}
\end{bmatrix};
C = \begin{bmatrix}
1 &amp; 0 \\
\end{bmatrix};
D = \begin{bmatrix}
0
\end{bmatrix}
\end{split}\]</div>
<section id="id1">
<h4>State-Space Matrices<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>

<span class="n">ip_parameters</span> <span class="o">=</span> <span class="n">InvertedPendulumParameters</span><span class="p">(</span>
    <span class="n">l</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geom_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">m</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">body_mass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">M</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">body_mass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="c1"># Dynamics matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Input matrix</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">gamma</span> <span class="o">/</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="p">)]]</span>
<span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="c1"># Output matrices</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">ip_parameters</span> <span class="o">=</span> <span class="n">InvertedPendulumParameters</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">l</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geom_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">m</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">body_mass</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">M</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">body_mass</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="c1"># Dynamics matrix</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>Model, States and Control inputs<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted_pendulum_lin</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">(</span><span class="s2">&quot;continuous&quot;</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span>
<span class="n">dtheta</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;dtheta&quot;</span><span class="p">)</span>
<span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;force&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="auxiliary-expressions">
<h4>Auxiliary Expressions<a class="headerlink" href="#auxiliary-expressions" title="Permalink to this heading">#</a></h4>
<p>We also define the pendulums kinetic and potential energies:</p>
<p><span class="math notranslate nohighlight">\(E_{\text{kinetic}} = \frac{1}{2} m \left( (l x_2 \cos(x_1))^{2} + (l x_2 \sin(x_1))^{2} \right) + \frac{1}{2}J x_2^2\)</span></p>
<p><span class="math notranslate nohighlight">\(E_{\text{potential}} = m g  l \cos(x_1)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inertia</span>
<span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
<span class="c1"># Energies</span>
<span class="n">E_kin</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="o">+</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="p">)</span>
<span class="n">E_pot</span> <span class="o">=</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">set_expression</span><span class="p">(</span><span class="s2">&quot;E_kinetic&quot;</span><span class="p">,</span> <span class="n">E_kin</span><span class="p">)</span>
<span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">set_expression</span><span class="p">(</span><span class="s2">&quot;E_potential&quot;</span><span class="p">,</span> <span class="n">E_pot</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Inertia</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># Energies</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">E_kin</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="o">+</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">)</span>

<span class="ne">NameError</span>: name &#39;ip_parameters&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-setup">
<h4>Model Setup<a class="headerlink" href="#model-setup" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;A&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>Discretization<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="n">inverted_pendulum_lin</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">discretize</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_lin</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">discretize</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="non-linear-model">
<h3>Non-Linear Model<a class="headerlink" href="#non-linear-model" title="Permalink to this heading">#</a></h3>
<p>We also define the full non-linear model</p>
<p>Application of Newtonian physics to this system leads to the <a class="reference external" href="https://sharpneat.sourceforge.io/research/cart-pole/cart-pole-equations.html">following model</a>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\ddot{y}(t) = \frac{1}{m\cos^2\theta(t) - (1+k)(M+m)} \left[
mg\sin\theta(t)\cos\theta(t) - (1+k)(\gamma f(t) + ml\dot\theta^2(t) \sin\theta(t) - \mu_c \dot{y}(t)) - \cfrac{\mu_p\cos\theta(t)}{l}\dot{\theta}(t)
\right]\\
\ddot\theta(t) = \frac{1}{(1+k)(M+m)l - ml\cos^2\theta(t)} \left[
(M+m)g\sin\theta(t) - \cos\theta(t) (\gamma f(t) + ml\dot\theta^2(t)\sin\theta(t) - \mu_c \dot{y}(t)) - \cfrac{(M+m)\mu_p}{ml} \dot{\theta}(t)
\right]
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(k = \frac{1}{3}.\)</span></p>
<p>We can convert this to state-space form with input <span class="math notranslate nohighlight">\(u(t) = f(t)\)</span> and output
<span class="math notranslate nohighlight">\(y(t)\)</span>; by introducing:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
X(t) = \begin{bmatrix}
x_1(t) \\ x_2(t) \\ x_3(t) \\ x_4(t)
\end{bmatrix}
= \begin{bmatrix}
y(t) \\ \theta(t) \\ \dot{y}(t) \\ \dot{\theta}(t) 
\end{bmatrix}
\end{split}\]</div>
<p>The system has the following full state-space model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\dot{X}(t) = \begin{bmatrix}
\dot{x_1}(t) \\ \dot{x_2}(t) \\ \dot{x_3}(t) \\ \dot{x_4}(t)
\end{bmatrix} =
\begin{bmatrix}
x_2(t) \\
x_4(t) \\
\frac{1}{m\cos^2 x_2(t) - (1+k)(M+m)} \left[
mg\sin x_2(t)\cos x_2(t) - (1+k)(\gamma u(t) + ml x_4^2(t) \sin x_2(t) - \mu_c x_3(t)) - \cfrac{\mu_p \cos x_2(t)}{l} x_4(t)
\right]\\
\frac{1}{(1+k)(M+m)l - ml\cos^2 x_2(t)} \left[
(M+m)g\sin x_2(t) - \cos x_2(t) (\gamma u(t) + ml x_4^2(t)\sin x_2(t) - \mu_c x_3(t)) - \cfrac{(M+m)\mu_p}{ml} x_4(t)
\right]
\end{bmatrix}
\end{split}\]</div>
<section id="id4">
<h4>Model, States and Control inputs<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted_pendulum</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;continuous&quot;</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span>
<span class="n">dpos</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span><span class="p">)</span>
<span class="n">dtheta</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;dtheta&quot;</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">var_type</span><span class="o">=</span><span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ode">
<h4>ODE<a class="headerlink" href="#ode" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>
<span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="n">ip_parameters</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">u</span>
        <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_c</span> <span class="o">*</span> <span class="n">dpos</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="o">/</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_p</span>
    <span class="o">*</span> <span class="n">dtheta</span>
<span class="p">)</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
    <span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span>
<span class="p">)</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">ddtheta</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

<span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="n">ip_parameters</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">u</span>
        <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_c</span> <span class="o">*</span> <span class="n">dpos</span>
    <span class="p">)</span>
    <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_p</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span>
<span class="p">)</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
    <span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span>
<span class="p">)</span>
<span class="n">ddpos</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="o">-</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="o">*</span> <span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="n">ip_parameters</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">u</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>         <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>         <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_c</span> <span class="o">*</span> <span class="n">dpos</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="o">-</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="o">/</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">mu_p</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="o">*</span> <span class="n">dtheta</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="n">ddtheta</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

<span class="ne">NameError</span>: name &#39;ip_parameters&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">dpos</span><span class="p">)</span>
<span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">)</span>
<span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="n">ddpos</span><span class="p">)</span>
<span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;dtheta&quot;</span><span class="p">,</span> <span class="n">ddtheta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">dpos</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;velocity&quot;</span><span class="p">,</span> <span class="n">ddpos</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_rhs</span><span class="p">(</span><span class="s2">&quot;dtheta&quot;</span><span class="p">,</span> <span class="n">ddtheta</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;ddpos&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h4>Auxiliary Expressions<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<p>And kinetic and potential energies:</p>
<p><span class="math notranslate nohighlight">\(E_{\text{kinetic}} = E_{\text{kinetic, cart}} + E_{\text{kinetic, pendulum}}\)</span></p>
<p><span class="math notranslate nohighlight">\(E_{\text{kinetic, cart}} = \frac{1}{2} M x_3^{2}\)</span></p>
<p><span class="math notranslate nohighlight">\(E_{\text{kinetic, pendulum}} = \frac{1}{2} m \left( (x_3 + l x_4 \cos(x_2))^{2} + (l x_4 \sin(x_2))^{2} \right) + \frac{1}{2} J x_4\)</span></p>
<p><span class="math notranslate nohighlight">\(E_{\text{potential}} = m g  l \cos(x_2)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inertia</span>
<span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
<span class="c1"># Energies</span>
<span class="n">E_kin</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span>
    <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="n">dpos</span><span class="o">**</span><span class="mi">2</span>
    <span class="o">+</span> <span class="mf">0.5</span>
    <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">dpos</span> <span class="o">+</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">E_pot</span> <span class="o">=</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_expression</span><span class="p">(</span><span class="s2">&quot;E_kinetic&quot;</span><span class="p">,</span> <span class="n">E_kin</span><span class="p">)</span>
<span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">set_expression</span><span class="p">(</span><span class="s2">&quot;E_potential&quot;</span><span class="p">,</span> <span class="n">E_pot</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Inertia</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_parameters</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># Energies</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">E_kin</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="mf">0.5</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">dtheta</span><span class="o">**</span><span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ip_parameters</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="n">dpos</span><span class="o">**</span><span class="mi">2</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="p">)</span>

<span class="ne">NameError</span>: name &#39;ip_parameters&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h4>Model Setup<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_model.py:970,</span> in <span class="ni">Model.setup</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">968</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">[</span><span class="n">rhs_i</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rhs_i</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">969</span>     <span class="n">_x_names</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">([</span><span class="n">rhs_i</span><span class="p">[</span><span class="s1">&#39;var_name&#39;</span><span class="p">]])</span>
<span class="ne">--&gt; </span><span class="mi">970</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Definition of right hand side (rhs) is incomplete. Missing: </span><span class="si">{}</span><span class="s1">. Use: set_rhs to define expressions.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_x_names</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">972</span> <span class="n">var_dict_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tvp</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">973</span> <span class="n">sym_struct_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_x</span><span class="p">,</span> <span class="n">_w</span><span class="p">,</span> <span class="n">_v</span><span class="p">,</span> <span class="n">_u</span><span class="p">,</span> <span class="n">_z</span><span class="p">,</span> <span class="n">_p</span><span class="p">,</span> <span class="n">_tvp</span><span class="p">]</span>

<span class="ne">AssertionError</span>: Definition of right hand side (rhs) is incomplete. Missing: {&#39;dtheta&#39;, &#39;velocity&#39;}. Use: set_rhs to define expressions.
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="helpers">
<h2>Helpers<a class="headerlink" href="#helpers" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FeedbackController</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">ConstantController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">u</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">EnvironmentSimulationResults</span><span class="p">:</span>
    <span class="n">frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">]</span>
    <span class="n">observations</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="n">actions</span><span class="p">:</span> <span class="n">NDArray</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_environment</span><span class="p">(</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Env</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">controller</span><span class="p">:</span> <span class="n">FeedbackController</span><span class="p">,</span>
    <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvironmentSimulationResults</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">RandomController</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="n">observation</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="n">observation</span><span class="p">]</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">observation</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

        <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

        <span class="c1"># Check if we need to stop the simulation</span>
        <span class="k">if</span> <span class="n">terminated</span> <span class="ow">or</span> <span class="n">truncated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">render_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
            <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">EnvironmentSimulationResults</span><span class="p">(</span>
        <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span>
        <span class="n">observations</span><span class="o">=</span><span class="n">observations</span><span class="p">,</span>
        <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="simulators">
<h3>Simulators<a class="headerlink" href="#simulators" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="n">mass_spring_damper_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mass_spring_damper_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="n">inverted_pendulum_lin_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_lin_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">t_step</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">cutoff_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="n">inverted_pendulum_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">inverted_pendulum</span><span class="p">)</span>
<span class="n">params_simulator</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Note: cvode doesn&#39;t support DAE systems.</span>
    <span class="s2">&quot;integration_tool&quot;</span><span class="p">:</span> <span class="s2">&quot;idas&quot;</span><span class="p">,</span>
    <span class="s2">&quot;abstol&quot;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
    <span class="s2">&quot;reltol&quot;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
    <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">params_simulator</span><span class="p">)</span>
<span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">cutoff_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_simulator</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">Simulator</span><span class="p">(</span><span class="n">inverted_pendulum</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">params_simulator</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="c1"># Note: cvode doesn&#39;t support DAE systems.</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="s2">&quot;integration_tool&quot;</span><span class="p">:</span> <span class="s2">&quot;idas&quot;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="p">}</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="dynamic-programming">
<h2>Dynamic Programming<a class="headerlink" href="#dynamic-programming" title="Permalink to this heading">#</a></h2>
<p>Dynamic programming (DP) is a method that in general solves optimization problems that involve making a sequence of decisions by determining, for each decision, subproblems that can be solved in like fashion, such that an optimal
solution of the original problem can be found from optimal solutions of sub-
problems. This method is based on Bellmans Principle of Optimality, which
he phrased as follows:</p>
<blockquote>
<div><p>An optimal policy has the property that whatever the initial state and
initial decision are, the remaining decisions must constitute an optimal
policy with regard to the state resulting from the first decision.</p>
</div></blockquote>
<figure>
    <img src="_static/images/30_optimality_principle.png"/>
</figure>
<p>Schematic illustration of the principle of optimality. The tail <span class="math notranslate nohighlight">\(\{u_k^, \dots, u_{N-1}^*\}\)</span> of an optimal sequence <span class="math notranslate nohighlight">\(\{u_0^, \dots, u_{N-1}^*\}\)</span> is optimal for the tail subproblem that starts at the state <span class="math notranslate nohighlight">\(x_k^*\)</span> of the optimal state trajectory.</p>
<p>Dynamic Programming is a very general solution method for problems which have two properties:</p>
<ul class="simple">
<li><p>Optimal substructure (Principle of optimality applies)</p>
<ul>
<li><p>Optimal solution can be decomposed into subproblems, e.g., shortest path</p></li>
</ul>
</li>
<li><p>Overlapping subproblems</p>
<ul>
<li><p>Subproblems recur many times</p></li>
<li><p>Solutions can be cached and reused</p></li>
</ul>
</li>
</ul>
<p>Dynamic programming is used across a wide variety of domains, e.g.</p>
<ul class="simple">
<li><p>Scheduling algorithms</p></li>
<li><p>Graph algorithms (e.g., shortest path algorithms)</p></li>
<li><p>Graphical models in ML (e.g., Viterbi algorithm)</p></li>
<li><p>Bioinformatics (e.g., Sequence alignment, Protein folding)</p></li>
</ul>
<p>We define the <strong>cost-to-go function</strong> (also known as <strong>optimal value function</strong>) as (for the sake of simplicity we will focus on the discrete-time case):</p>
<div class="math notranslate nohighlight">
\[
V_0(x_0) := \min_{u \in \mathbf{U}} J_0(x_0, u)
\]</div>
<p>An admissible control sequence <span class="math notranslate nohighlight">\(u^*\)</span> is called optimal, if</p>
<div class="math notranslate nohighlight">
\[
V_0(x_0) = J_0(x_0, u^*)
\]</div>
<p>For any feasible <span class="math notranslate nohighlight">\(x_0 \in \mathbf{X}\)</span> the optimal value function satisfies</p>
<div class="math notranslate nohighlight">
\[
V_k(x_0) = \displaystyle \min_{u \in \mathbf{U}} g_{k}(x_0, u) + V_{k+1}(f(x_0, u))
\]</div>
<p>Moreover, if <span class="math notranslate nohighlight">\(u^*\)</span> is an optimal control, then</p>
<div class="math notranslate nohighlight">
\[
V_0(x_0) = g_{k}(x_0, u) + V_{k+1}(f(x_0, u))
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
V_0(x_0) = J_0(x_0, u^*)
\]</div>
<section id="dp-algorithm">
<h3>DP Algorithm<a class="headerlink" href="#dp-algorithm" title="Permalink to this heading">#</a></h3>
<p>For every initial state <span class="math notranslate nohighlight">\(x_0\)</span>, the optimal cost is equal to <span class="math notranslate nohighlight">\(V_N(x_0)\)</span>, given by the last step of the following algorithm, which proceeds backward in time from stage <span class="math notranslate nohighlight">\(N-1\)</span> to stage <span class="math notranslate nohighlight">\(0\)</span>:</p>
<ul>
<li><p>Start with <span class="math notranslate nohighlight">\(V_N(x_N) = g_N(x_N)\)</span></p></li>
<li><p>then for <span class="math notranslate nohighlight">\(k = \{0, \dots , N - 1\}\)</span>, let:</p>
<div class="math notranslate nohighlight">
\[
  V_{k}(x_{k}) = \displaystyle \min_{u \in \mathbf{U}} \left\{ g_{k}(x_{k}, u_{k}) + V_{k+1}(f(x_{k}, u_{k})) \right\}
  \]</div>
</li>
</ul>
<p>Once the functions <span class="math notranslate nohighlight">\(V_0, \dots , V_N\)</span> have been obtained, we can use a forward algorithm to construct an optimal control sequence <span class="math notranslate nohighlight">\(\{u_0^*, \dots, u_{N-1}^*\}\)</span> and corresponding state trajectory <span class="math notranslate nohighlight">\(\{x_1^, \dots, x_{N}^*\}\)</span> for the given initial state <span class="math notranslate nohighlight">\(x_0\)</span> .</p>
<figure>
    <img src="_static/images/30_dynamic_programming.png" width="%80"/>
</figure>
<p>Illustration of the DP algorithm. The tail subproblem that starts at <span class="math notranslate nohighlight">\(x_k\)</span> at time <span class="math notranslate nohighlight">\(k\)</span> minimizes over
<span class="math notranslate nohighlight">\(\{u_k , \dots , u_{N-1}\}\)</span> the cost-to-go from <span class="math notranslate nohighlight">\(k\)</span> to <span class="math notranslate nohighlight">\(N\)</span>.</p>
</section>
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">G</span> <span class="o">=</span> <span class="n">create_shortest_path_graph</span><span class="p">()</span>
<span class="n">plot_shortest_path_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">G</span> <span class="o">=</span> <span class="n">create_shortest_path_graph</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">plot_shortest_path_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_shortest_path_graph&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We wish to travel from node A to node G at minimum cost. If the cost represents time then we want to find the shortest path from A to G.</p>
<ul class="simple">
<li><p>Arrows (edges) indicate the possible movements.</p></li>
<li><p>Numbers on edges indicate the cost of moving along an edge.</p></li>
</ul>
<p>Use Dynamic Programming to solve this problem.</p>
<blockquote>
<div><p><strong>Hint</strong> Determine all possible paths first and then compute the cost-to-go at each node.</p>
</div></blockquote>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_all_paths_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plot_all_paths_graph</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;plot_all_paths_graph&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Each node in this new graph represents a state. We will start from the tail (the last states) and compute recursively the cost for each state transition.</p>
<p>We start by determining the cost-to-go for all positions.</p>
<p>Let <span class="math notranslate nohighlight">\(l(n_1, n_2)\)</span> the cost of going from node <span class="math notranslate nohighlight">\(n_1\)</span> to <span class="math notranslate nohighlight">\(n_2\)</span> and <span class="math notranslate nohighlight">\(V(n)\)</span> be the cost-to-go from node <span class="math notranslate nohighlight">\(n\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
V(\text{ABDF}) &amp;= g(\text{ABDF}, \text{ABDFG}) &amp;= 1\\
V(\text{ABE}) &amp;= g(\text{ABE}, \text{ABEG}) &amp;= 4\\
V(\text{ACF}) &amp;= g(\text{ACF}, \text{ACFG}) &amp;= 1\\
V(\text{ADF}) &amp;= g(\text{ADF}, \text{ADFG}) &amp;= 1\\
\end{array}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
V(\text{ABD}) &amp;= \min \left[ g(\text{ABD}, \text{ABDG}), g(\text{ABD}, \text{ABDF}) + V(\text{ABDF}) \right]
&amp;= \min \left[ 8, 5 + 1 \right] &amp;= 6
\\
V(\text{AB}) &amp;= \min \left[ g(\text{AB}, \text{ABD}) + V(\text{ABD}), g(\text{AB}, \text{ABE}) + V(\text{ABE}) \right]
&amp;= \min \left[ 9 + 6, 1 + 4 \right] &amp;= 5
\\
V(\text{AC}) &amp;= g(\text{AC}, \text{ACF}) + V(\text{ACF}) &amp;= 2 + 1 &amp;= 3
\\
V(\text{AD}) &amp;= \min \left[ g(\text{AD}, \text{ADF}) + V(\text{ADF}), g(\text{AD}, \text{ADG})) \right]
&amp;= \min \left[ 5 + 1, 8 \right] &amp;= 6
\\
\end{array}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
V(\text{A}) &amp;= \min \left[
g(\text{A}, \text{AB}) + V(\text{AB}), g(\text{A}, \text{AC}) + V(\text{AC}), g(\text{A}, \text{AD}) + V(\text{AD})
\right]
&amp;= \min \left[ 1 + 5, 5 + 3, 3 + 6 \right] &amp;= 6
\\
\end{array}
\end{split}\]</div>
<p>The shortest-path is ABEG.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_all_paths_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">show_solution</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plot_all_paths_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">show_solution</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;plot_all_paths_graph&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="linear-quadratic-regulator">
<h2>Linear Quadratic Regulator<a class="headerlink" href="#linear-quadratic-regulator" title="Permalink to this heading">#</a></h2>
<p>While solving the optimal control problem (OCP) is very hard in general, there are a few very important special cases where the solutions are very accessible. Most of these involve variants on the case of linear dynamics and quadratic cost. The simplest case, called the linear quadratic regulator (LQR), is formulated as stabilizing a time-invariant linear system to the origin can be solved analytically.</p>
<p>For a discrete-time linear system described by:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{x}_{t+1} = A \mathbf{x}_t + B \mathbf{u}_t
\]</div>
<p>where <span class="math notranslate nohighlight">\(x\in \mathbb {R} ^{n}\)</span> (that is, <span class="math notranslate nohighlight">\(x\)</span> is an <span class="math notranslate nohighlight">\(n\)</span>-dimensional real-valued vector) is the state of the system and <span class="math notranslate nohighlight">\(u\in \mathbb {R} ^{m}\)</span> is the control input. Given a quadratic cost function for the system in the infinite-horizon case, defined as:</p>
<div class="math notranslate nohighlight">
\[
J(\mathbf{x}_0, \mathbf{u}) = \sum \limits _{k = 0}^{\infty} \mathbf{x}_k^{T}Q \mathbf{x}_k + \mathbf{u}_k^{T} R \mathbf{u}_k
\]</div>
<p>With <span class="math notranslate nohighlight">\(Q = Q^T \succeq 0\)</span>, <span class="math notranslate nohighlight">\(R = R^T \succeq 0\)</span>.</p>
<p>In both cases, the control law that minizes the cost is given by:</p>
<div class="math notranslate nohighlight">
\[
u_k = -K x_k
\]</div>
<p>With: <span class="math notranslate nohighlight">\(K = (R + B^T P B)^{-1} B^T P B\)</span></p>
<p>and <span class="math notranslate nohighlight">\(P\)</span> is found by solving the discrete time algebraic Riccati equation (DARE):</p>
<div class="math notranslate nohighlight">
\[
Q + A^{T}PA-(A^{T}PB)(R+B^{T}PB)^{-1}(B^{T}PA) = P.
\]</div>
<center>
<figure>
    <img src="_static/images/30_lqr_block_diagram.svg" width="60%"/>
    <figcaption>
        LQR Block Diagram.
    </figcaption>
</figure>
</center><section id="mass-spring-damper">
<h3>Mass-Spring-Damper<a class="headerlink" href="#mass-spring-damper" title="Permalink to this heading">#</a></h3>
<p>Now, we design Linear Quadratic Regulator for the Mass-Spring-Damper model. First, we create an instance of the LQR class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/controller/_lqr.py:103,</span> in <span class="ni">LQR.__init__</span><span class="nt">(self, model)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">:</span><span class="n">LinearModel</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span>     <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="ne">--&gt; </span><span class="mi">103</span>     <span class="n">IteratedVariables</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">LinearModel</span><span class="p">),</span> <span class="s1">&#39;LQR can only be used with linear models. Initialize the model with LinearModel class.&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Model for LQR was not setup. After the complete model creation call model.setup().&#39;</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_iteratedvariables.py:40,</span> in <span class="ni">IteratedVariables.__init__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="k">assert</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;Cannot initialize variables before assigning the model to the current class instance.&#39;</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span> <span class="c1"># Initialize structure for intial conditions:</span>
<span class="ne">---&gt; </span><span class="mi">40</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_u</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_z</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="ne">TypeError</span>: &#39;dict&#39; object is not callable
</pre></div>
</div>
</div>
</div>
<p>We choose an infinite prediction horizon (<code class="docutils literal notranslate"><span class="pre">n_horizon</span> <span class="pre">=</span> <span class="pre">None</span></code>), the time step <code class="docutils literal notranslate"><span class="pre">t_step</span> <span class="pre">=</span> <span class="pre">0.04s</span></code> second (which is the same as the environments timestep).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">)</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">t_step</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">n_horizon</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># infinite horizon</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">t_step</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">n_horizon</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># infinite horizon</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The goal is to drive the Mass-Spring-Damper system to the desired position. For that we define the following objective.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
<span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">lqr</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;display_array&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We then complete the LQR setup.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Finally, we set the desired setpoint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">xss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">lqr</span><span class="o">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">xss</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="simulation">
<h4>SImulation<a class="headerlink" href="#simulation" title="Permalink to this heading">#</a></h4>
<p>Now, we simulate the closed-loop system for 50 steps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">lqr</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_mass_spring_damper_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluation">
<h4>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this heading">#</a></h4>
<p>Finally, we evaluate the controller on the actual environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LQRController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lqr</span><span class="p">:</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lqr</span> <span class="o">=</span> <span class="n">lqr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lqr</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">observation</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span>
    <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span>
<span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">LQRController</span><span class="p">(</span><span class="n">lqr</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">LQRController</span><span class="p">(</span><span class="n">lqr</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;show_video&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">default_plot</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">37</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">default_plot</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="id7">
<h2>Exercise<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Change the cost matrices of the LQR problem above and try to find the best combinations.</p></li>
<li><p>Design an LQR controller for the inverted pendulum.</p></li>
</ul>
</section>
<section id="id8">
<h2>Solution<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h2>
<section id="inverted-pendulum">
<h3>Inverted Pendulum<a class="headerlink" href="#inverted-pendulum" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">38</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/controller/_lqr.py:103,</span> in <span class="ni">LQR.__init__</span><span class="nt">(self, model)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">:</span><span class="n">LinearModel</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span>     <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="ne">--&gt; </span><span class="mi">103</span>     <span class="n">IteratedVariables</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">LinearModel</span><span class="p">),</span> <span class="s1">&#39;LQR can only be used with linear models. Initialize the model with LinearModel class.&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Model for LQR was not setup. After the complete model creation call model.setup().&#39;</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_iteratedvariables.py:40,</span> in <span class="ni">IteratedVariables.__init__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="k">assert</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;Cannot initialize variables before assigning the model to the current class instance.&#39;</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span> <span class="c1"># Initialize structure for intial conditions:</span>
<span class="ne">---&gt; </span><span class="mi">40</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_u</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_z</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="ne">TypeError</span>: &#39;dict&#39; object is not callable
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">t_step</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">n_horizon</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># infinite horizon</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">t_step</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">lqr</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">n_horizon</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># infinite horizon</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting the objective</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
<span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">line</span> <span class="mi">4</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">display_array</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">lqr</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;display_array&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define set point</span>
<span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">lqr</span><span class="o">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">xss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Define set point</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">lqr</span><span class="o">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">xss</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="id9">
<h4>Simulation<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">lqr</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_inverted_pendulum_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id10">
<h4>Evaluation<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LQRController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lqr</span><span class="p">:</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">LQR</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lqr</span> <span class="o">=</span> <span class="n">lqr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lqr</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lqr</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">observation</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">LQRController</span><span class="p">(</span><span class="n">lqr</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">46</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">LQRController</span><span class="p">(</span><span class="n">lqr</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">47</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;show_video&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">default_plot</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_list</span><span class="o">=</span><span class="p">[])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">48</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">graphics</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">default_plot</span><span class="p">(</span><span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_list</span><span class="o">=</span><span class="p">[])</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lqr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>

<span class="ne">NameError</span>: name &#39;lqr&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="model-predictive-control">
<h1>Model Predictive Control<a class="headerlink" href="#model-predictive-control" title="Permalink to this heading">#</a></h1>
<p>Unfortunately, the analytically convenient linear quadratic problem formulations are often not satisfactory. There are two main reasons for this:</p>
<ul class="simple">
<li><p>The system may be nonlinear, and it may be inappropriate to use for
control purposes. Moreover, some of the control variables may be naturally
discrete, and this is incompatible with the linear system viewpoint.</p></li>
<li><p>There may be control and/or state constraints, which are not handled
adequately through quadratic penalty terms in the cost function. For
example, the motion of a car may be constrained by the presence of
obstacles and hardware limitations.
The solution obtained from a linear quadratic model may not be suitable for such
a problem, because quadratic penalties treat constraints softly
and may produce trajectories that violate the constraints.</p></li>
</ul>
<p>Model Predictive Control (MPC) is a control algorithm based on solving an <strong>on-line</strong> optimal control problem. A receding horizon approach is used which can be summarized in the following steps:</p>
<ol class="arabic simple">
<li><p>At time <span class="math notranslate nohighlight">\(t\)</span> and for the current state <span class="math notranslate nohighlight">\(x_t\)</span>, solve, on-line, an open-loop optimal control problem over some future interval taking account the current and future constraints.</p></li>
<li><p>Apply the first step in the optimal control sequence.</p></li>
<li><p>Repeat the procedure at time <span class="math notranslate nohighlight">\(t + 1\)</span> using the current state <span class="math notranslate nohighlight">\(x_{t + 1}\)</span>.</p></li>
</ol>
<div>
<figure style="float: left; width: 60%;">
    <img src="_static/images/30_model_predictive_control_horizon.svg" width="100%"/>
</figure>
<div style="float: right; width: 39%;">
<br><br><br>Illustration of the problem solved by MPC at state $x_k$.
We minimize the cost function over the next $l$ stages.
We then apply the control of the optimizing sequence up to the control horizon.
In most cases, the control horizon is set to 1.
</div>
</div><center>
<figure>
    <img src="_static/images/30_mpc_block_diagram.svg" width="80%"/>
    <figcaption>
        MPC Block Diagram.
    </figcaption>
</figure>
</center><p>A major difference between MPC and finite-state stochastic control problems
that are popular in the RL/artificial intelligence literature is that in MPC
the state and control spaces are continuous/infinite, such as for example
in self-driving cars, the control of aircraft and drones, or the operation of
chemical processes</p>
<section id="iterative-linear-quadratic-regulator">
<h2>Iterative Linear Quadratic Regulator<a class="headerlink" href="#iterative-linear-quadratic-regulator" title="Permalink to this heading">#</a></h2>
<p>Iterative Linear Quadratic Regulator (iLQR) is an extension of LQR control to non-linear system with non-linear quadratic costs.</p>
<p>The idea is to approximate the cost and dynamics as quadratic and affine, respectively, then exactly solve the resulting LQR problem.</p>
<p>Given a discrete-time non-linear system with state-space representation:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{x}_{t+1} = f(\mathbf{x}_t, \mathbf{u}_t)
\]</div>
<p>we approximate it with a first-order Taylor-series expansion about nominal trajectories
<span class="math notranslate nohighlight">\(\mathbf{X} = \{\mathbf{x}_0, \dots, \mathbf{x}_N\}, \mathbf{U} = \{ \mathbf{u}_0, \dots, \mathbf{u}_N \}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\mathbf{x}_{t+1} + \delta\mathbf{x}_{t+1} &amp;= f(\mathbf{x}_t + \delta \mathbf{x}_t, \mathbf{u}_t + \delta \mathbf{u}_t) \\ 
&amp; \approx f(\mathbf{x}_t, \mathbf{u}_t)
+ \frac{\partial f}{\partial \mathbf{x}}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{x}_t
+ \frac{\partial f}{\partial \mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{u}_t\\
\delta\mathbf{x}_{t+1} &amp;= A_t\delta\mathbf{x}_t + B_t\delta\mathbf{u}_t
\end{array}
\end{split}\]</div>
<p>with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
A_t = A(\mathbf{x}_t, \mathbf{u}_t) = \frac{\partial f}{\partial \mathbf{x}}|_{\mathbf{x}_t, \mathbf{u}_t}\\
B_t = B(\mathbf{x}_t, \mathbf{u}_t) = \frac{\partial f}{\partial \mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t}\\
\end{split}\]</div>
<p>Given a general cost function that is not linear-quadratic, we use a second-order Taylor Series Expansion to linearize the dynamics into a form common for optimal control problems:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
J_N(\mathbf{x}_0, \mathbf{U}) &amp;=
l_f(\mathbf{x}_N) + \sum \limits_{t=1}^{N-1} l(\mathbf{x}_t, \mathbf{u}_t)\\
&amp;\approx \frac{1}{2} \mathbf{x}^T_N Q \mathbf{x}_N + q_N^T \mathbf{x}_N
+ \sum \limits_{t=1}^{N-1}
\frac{1}{2} \mathbf{x}^T_t Q_t \mathbf{x}_t
+ \frac{1}{2} \mathbf{u}^T_t R_t \mathbf{u}_t
+ \frac{1}{2} \mathbf{x}^T_t H_t \mathbf{u}_t
+ \frac{1}{2} \mathbf{u}^T_t H_t^T \mathbf{x}_t
+ q_t^T \mathbf{x}_t +  + r_t^T \mathbf{u}_t
\end{array}
\end{split}\]</div>
<p>We define the following variables for convenience:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
l_x &amp;:= \frac{\partial l}{\partial \mathbf{x}}|_{\mathbf{x}_t, \mathbf{u}_t} = Q_t \mathbf{x}_t + q_t
\\
l_u &amp;:= \frac{\partial l}{\partial \mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t} = R_t \mathbf{u}_t + r_t
\\
l_{xx} &amp;:= \frac{\partial^2 l}{\partial \mathbf{x}^2}|_{\mathbf{x}_t, \mathbf{u}_t} = Q_t
\\
l_{uu} &amp;:= \frac{\partial^2 l}{\partial \mathbf{u}^2}|_{\mathbf{x}_t, \mathbf{u}_t} = R_t
\\
l_{xu} &amp;:= \frac{\partial^2 l}{\partial \mathbf{x}\mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t} = H_t
\\
l_{ux} &amp;:= \frac{\partial^2 l}{\partial \mathbf{u}\mathbf{x}}|_{\mathbf{x}_t, \mathbf{u}_t} = H_t^T
\end{array}
\end{split}\]</div>
<p>We can apply Bellmans Principle of Optimality to define the optimal cost-to-go:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
V_N(\mathbf{x}_N) &amp;= g_f(\mathbf{x}_N)\\
V_{t}(\mathbf{x}_t) &amp;= \displaystyle \min_u {g(\mathbf{x}_{t}, \mathbf{u}_{t}) + V_{t+1}(f(\mathbf{x}_{t}, \mathbf{u}_{N-t}))}\\
V_{t}(\mathbf{x}_t) &amp;= \displaystyle \min_u Q_{t}(\mathbf{x}_{t}, \mathbf{u}_{t})
\end{array}\\
\end{split}\]</div>
<p>The <span class="math notranslate nohighlight">\(Q\)</span>-function is the discrete-time analogue of the Hamiltonian, sometimes known as the pseudo-Hamiltonian.</p>
<p>We approximate the cost-to-go function as locally quadratic near the nominal trajectory gives us (we drop the time index in some of the equations for the sake of readability):</p>
<div class="math notranslate nohighlight">
\[
\delta V(\mathbf{x}) = s^T \delta\mathbf{x} + \frac{1}{2} \delta\mathbf{x}^T S \delta\mathbf{x}
\]</div>
<p>with
<span class="math notranslate nohighlight">\(s = \frac{\partial V}{\partial \mathbf{x}}|_{\mathbf{x}},
S = \frac{\partial^2 V}{\partial \mathbf{x}^2}|_{\mathbf{x}}\)</span></p>
<p>Similarily:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\delta Q(\mathbf{x}, \mathbf{u}) = 
\frac{1}{2}
\begin{bmatrix} \delta\mathbf{x} \\ \delta\mathbf{u} \end{bmatrix}^T
\begin{bmatrix} Q_{xx} &amp; Q_{xu} \\ Q_{ux} &amp; Q_{uu} \end{bmatrix}
\begin{bmatrix} \delta\mathbf{x} \\ \delta\mathbf{u} \end{bmatrix}
+
\begin{bmatrix} Q_{x} \\ Q_{u} \end{bmatrix}^T
\begin{bmatrix} \delta\mathbf{x} \\ \delta\mathbf{u} \end{bmatrix}
\end{split}\]</div>
<p>with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
Q_x &amp;= l_x + s_{t+1} A_t \\
Q_u &amp;= l_u + s_{t+1} B_t \\
Q_{xx} &amp;= l_{xx} + A_t^T S_{t+1} A_t \\
Q_{uu} &amp;= l_{uu} + B_t^T S_{t+1} B_t \\
Q_{ux} &amp;= l_{ux} + B_t^T S_{t+1} A_t
\end{array}
\end{split}\]</div>
<p>The optimal control modification <span class="math notranslate nohighlight">\(\delta\mathbf{u}^\)</span> for some state perturbation <span class="math notranslate nohighlight">\(\delta\mathbf{x}\)</span>, is obtained by minimizing the quadratic model:</p>
<div class="math notranslate nohighlight">
\[
\delta\mathbf{u}^(\delta\mathbf{x}) = \displaystyle\arg\min_{\delta\mathbf{u}} Q(\delta\mathbf{x}, \delta\mathbf{u}) = k + K\delta\mathbf{x}
\]</div>
<p>This is a locally-linear feedback policy with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
k := -Q_{uu}^{-1}Q_u\\
K := -Q_{uu}^{-1}Q_{ux}
\end{split}\]</div>
<p>Plugging this back into the expansion of <span class="math notranslate nohighlight">\(Q\)</span>, a quadratic model of <span class="math notranslate nohighlight">\(V\)</span> is obtained. After simplification it is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\Delta V &amp;= \frac{1}{2} k^T Q_{uu} k + k^T Q_u\\
s &amp;= Q_x + K^T Q_{uu} k + K^T Q_u + Q_{ux}^T k\\
S &amp;= Q_{xx} + K^T Q_{uu} K + K^T Q_{ux} + Q_{ux}^T K
\end{array}
\end{split}\]</div>
<p>Once these terms are computed, a forward pass computes a new trajectory:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\hat{x}_0 &amp;= x_0\\
\hat{u}_t &amp;= u_t + k_t + K_t(\hat{x}_t - x_t)\\
\hat{x}_{t+1} &amp;= f(\hat{x}_t, \hat{u}_t)
\end{array}
\end{split}\]</div>
<p>The basic flow of the algorithm is:</p>
<ol class="arabic simple">
<li><p>Initialize with initial state <span class="math notranslate nohighlight">\(\mathbf{x}_0\)</span> and initial control sequence <span class="math notranslate nohighlight">\(\mathbf{U} = \{\mathbf{u}_{0}, \mathbf{u}_{1}, \dots, \mathbf{u}_{N-1}\}\)</span>.</p></li>
<li><p>Do a forward pass using the non-linear dynamics, i.e. simulate the system using <span class="math notranslate nohighlight">\((\mathbf{x}_0, \mathbf{U})\)</span> to get the trajectory through state space, <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>, that results from applying the control sequence <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> starting in <span class="math notranslate nohighlight">\(\mathbf{x}_0\)</span>.</p></li>
<li><p>Do a backward pass, estimate the value function and dynamics for each <span class="math notranslate nohighlight">\((\mathbf{x}, \mathbf{u})\)</span> in the state-space and control signal trajectories.</p></li>
<li><p>Calculate an updated control signal <span class="math notranslate nohighlight">\(\hat{\mathbf{U}}\)</span> and evaluate cost of trajectory resulting from <span class="math notranslate nohighlight">\((\mathbf{x}_0, \hat{\mathbf{U}})\)</span>.</p>
<ol class="arabic simple">
<li><p>If <span class="math notranslate nohighlight">\(|(\textrm{cost}(x_0, \hat{\textbf{U}}) - \textrm{cost}(x_0, \textbf{U})| &lt; \textrm{threshold},\)</span> then weve converged and exit.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\textrm{cost}(x_0, \hat{\textbf{U}}) &lt; \textrm{cost}(x_0, \textbf{U}),\)</span> then set <span class="math notranslate nohighlight">\(\textbf{U} = \hat{\textbf{U}},\)</span> and change the update size to be more aggressive. Go back to step 2.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\textrm{cost}(x_0, \hat{\textbf{U}}) \geq \textrm{cost}(x_0, \textbf{U}),\)</span> change the update size to be more modest. Go back to step 3.</p></li>
</ol>
</li>
</ol>
</section>
<section id="differential-dynamic-programming">
<h2>Differential Dynamic Programming<a class="headerlink" href="#differential-dynamic-programming" title="Permalink to this heading">#</a></h2>
<p>Differential Dynamic Programming (DDP) is almost identical to iLQR but unlike the latter, it expands the systems dynamics to the second order i.e. for a given a discrete-time non-linear system with state-space representation:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{x}_{t+1} = f(\mathbf{x}_t, \mathbf{u}_t)
\]</div>
<p>we approximate it with a <strong>second-order</strong> Taylor-series expansion about nominal trajectories
<span class="math notranslate nohighlight">\(\mathbf{X} = \{\mathbf{x}_0, \dots, \mathbf{x}_N\}, \mathbf{U} = \{ \mathbf{u}_0, \dots, \mathbf{u}_N \}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\mathbf{x}_{t+1} + \delta\mathbf{x}_{t+1} &amp;= f(\mathbf{x}_t + \delta \mathbf{x}_t, \mathbf{u}_t + \delta \mathbf{u}_t) \\ 
&amp; \approx f(\mathbf{x}_t, \mathbf{u}_t)
+ \frac{\partial f}{\partial \mathbf{x}}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{x}_t
+ \frac{\partial f}{\partial \mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{u}_t
+ \frac{1}{2} \left(
\frac{\partial^2 f}{\partial \mathbf{x}^2}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{x}_t^2
+ 2 \frac{\partial^2 f}{\partial \mathbf{x}\mathbf{u}}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{x}_t\delta\mathbf{u}_t
+ \frac{\partial^2 f}{\partial \mathbf{u}^2}|_{\mathbf{x}_t, \mathbf{u}_t}\delta\mathbf{u}_t^2
\right)
\\
\delta\mathbf{x}_{t+1} &amp;= f_x\delta\mathbf{x}_t + f_u\delta\mathbf{u}_t + \frac{1}{2} \left(
f_{xx} \delta\mathbf{x}_t^2 + 2 f_{xu} \delta\mathbf{x}_t \delta\mathbf{u}_t + f_{uu} \delta\mathbf{u}_t^2
\right)
\end{array}
\end{split}\]</div>
<p>Which leads to a different expansion of the <span class="math notranslate nohighlight">\(Q\)</span>-function:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
Q_x &amp;= l_x + f_x^T s_{t+1} \\
Q_u &amp;= l_u + f_u^T s_{t+1} \\
Q_{xx} &amp;= l_{xx} + f_x^T S_{t+1} f_x + S_{t+1} \cdot f_{xx} \\
Q_{uu} &amp;= l_{uu} + B_t^T S_{t+1} B_t + S_{t+1} \cdot f_{xu} \\
Q_{ux} &amp;= l_{ux} + B_t^T S_{t+1} A_t + S_{t+1} \cdot f_{uu} 
\end{array}
\end{split}\]</div>
<p>The difference with iLQR is that the last term in the last 3 equations is the product of a vector with a tensor.</p>
<p>The optimal control modification <span class="math notranslate nohighlight">\(\delta\mathbf{u}^\)</span> for some state perturbation <span class="math notranslate nohighlight">\(\delta\mathbf{x}\)</span>, is obtained by minimizing the quadratic model:</p>
<div class="math notranslate nohighlight">
\[
\delta\mathbf{u}^(\delta\mathbf{x}) = \displaystyle\arg\min_{\delta\mathbf{u}} Q(\delta\mathbf{x}, \delta\mathbf{u}) = k + K\delta\mathbf{x}
\]</div>
<p>This is a locally-linear feedback policy with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
k := -Q_{uu}^{-1}Q_u\\
K := -Q_{uu}^{-1}Q_{ux}
\end{split}\]</div>
<p>Plugging this back into the expansion of <span class="math notranslate nohighlight">\(Q\)</span>, a quadratic model of <span class="math notranslate nohighlight">\(V\)</span> is obtained. After simplification it is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}\\
\Delta V &amp;= -\frac{1}{2} k^T Q_{uu} k\\
s &amp;= Q_x - K^T Q_{uu} k\\
S &amp;= Q_{xx} - K^T Q_{uu} K
\end{array}
\end{split}\]</div>
<section id="id11">
<h3>Mass-Spring-Damper<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://www.do-mpc.com/en/latest/">do-mpc</a> uses <a class="reference external" href="https://web.casadi.org/python-api/">CasADi</a> (an open-source tool for nonlinear optimization and algorithmic differentiation) for the modeling part and for the different cost functions. Heres a table of useful operators:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Equation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://web.casadi.org/python-api/#casadi.casadi.sumsqr">casadi.sumsqr(x)</a></p></td>
<td><p>Squared-sum</p></td>
<td><p><span class="math notranslate nohighlight">\(\sum x_i^2\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://web.casadi.org/python-api/#casadi.casadi.norm_2">casadi.norm_2(x)</a></p></td>
<td><p><span class="math notranslate nohighlight">\(L_2\)</span>-norm</p></td>
<td><p><span class="math notranslate nohighlight">\(\sqrt{\sum x_i^2}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://web.casadi.org/python-api/#casadi.casadi.norm_1">casadi.norm_1(x)</a></p></td>
<td><p><span class="math notranslate nohighlight">\(L_1\)</span>-norm</p></td>
<td><p>$\sum</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://web.casadi.org/python-api/#casadi.casadi.bilin">casadi.bilin(A, x)</a></p></td>
<td><p>Quadratic Form</p></td>
<td><p><span class="math notranslate nohighlight">\(x^T A x\)</span></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://web.casadi.org/python-api/#casadi.casadi.bilin">casadi.bilin(A, x, y)</a></p></td>
<td><p>Bilinear Form</p></td>
<td><p><span class="math notranslate nohighlight">\(x^T A y\)</span></p></td>
</tr>
</tbody>
</table>
<section id="controller">
<h4>Controller<a class="headerlink" href="#controller" title="Permalink to this heading">#</a></h4>
<p>First, we create an instance of the MPC class is generated with the Mass-Spring-Damper prediction model defined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">49</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/controller/_mpc.py:146,</span> in <span class="ni">MPC.__init__</span><span class="nt">(self, model, settings)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MPCSettings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span>     <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="ne">--&gt; </span><span class="mi">146</span>     <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Model for MPC was not setup. After the complete model creation call model.setup().&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">MPCData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;MPC&#39;</span>

<span class="ne">AssertionError</span>: Model for MPC was not setup. After the complete model creation call model.setup().
</pre></div>
</div>
</div>
</div>
<p>We choose the finite prediction horizon <code class="docutils literal notranslate"><span class="pre">n_horizon</span> <span class="pre">=</span> <span class="pre">20</span></code>, the time step <code class="docutils literal notranslate"><span class="pre">t_step</span> <span class="pre">=</span> <span class="pre">0.04s</span></code> to be the same as the environments time step. We also set the parameters of the applied discretization scheme orthogonal collocation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
    <span class="s2">&quot;state_discretization&quot;</span><span class="p">:</span> <span class="s2">&quot;collocation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;radau&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_deg&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;collocation_ni&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;store_full_solution&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Use MA27 linear solver in ipopt for faster calculations:</span>
    <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="p">}</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="objective">
<h4>Objective<a class="headerlink" href="#objective" title="Permalink to this heading">#</a></h4>
<p>The control objective is to move the mass to a desired position (<code class="docutils literal notranslate"><span class="pre">0.1</span></code>) and keep it there.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">distance_cost</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">casadi</span><span class="o">.</span><span class="n">norm_2</span><span class="p">(</span><span class="n">mass_spring_damper</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">cat</span> <span class="o">-</span> <span class="n">xss</span><span class="p">)</span>
<span class="n">terminal_cost</span> <span class="o">=</span> <span class="n">distance_cost</span>
<span class="n">stage_cost</span> <span class="o">=</span> <span class="n">distance_cost</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terminal_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">terminal_cost</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">stage_cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>stage_cost=SX((100*sqrt((sq((position-0.1))+sq(velocity)))))
terminal_cost=SX((100*sqrt((sq((position-0.1))+sq(velocity)))))
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">51</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terminal_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">terminal_cost</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">stage_cost</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We also restrict the input force.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">1e-2</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">52</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">1e-2</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="constraints">
<h4>Constraints<a class="headerlink" href="#constraints" title="Permalink to this heading">#</a></h4>
<p>We apply constraints on the force. In this case, there is only an upper and lower bounds for the force.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lower and upper bounds of the input</span>
<span class="n">u_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u_max</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_max</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">53</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># lower and upper bounds of the input</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">u_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u_max</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_max</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup">
<h4>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h4>
<p>We can now setup the controller.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">54</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h4>Simulation<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h4>
<p>We set the initial state and simulate the closed-loop for 100 steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">55</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mass_spring_damper_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">56</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_mass_spring_damper_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h4>Evaluation<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h4>
<p>Finally, we evaluate the controller on the actual environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MPCController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpc</span><span class="p">:</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">observation</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span>
    <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span>
<span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">58</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_mass_spring_damper_environment</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_mass_spring_damper_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;show_video&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_mass_spring_damper_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_mass_spring_damper_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="id14">
<h2>Exercise<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Design an MPC controller for the linearized inverted pendulum.</p></li>
<li><p>For each case, try different cost functions:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\sum \theta^2\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\sum |\theta|\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(E_{\text{kinetic}} - E_{\text{potential}}\)</span></p></li>
</ul>
</li>
</ul>
</section>
<section id="id15">
<h2>Solution<a class="headerlink" href="#id15" title="Permalink to this heading">#</a></h2>
<section id="id16">
<h3>Controller<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">61</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">inverted_pendulum_lin</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/controller/_mpc.py:146,</span> in <span class="ni">MPC.__init__</span><span class="nt">(self, model, settings)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MPCSettings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span>     <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="ne">--&gt; </span><span class="mi">146</span>     <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Model for MPC was not setup. After the complete model creation call model.setup().&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">MPCData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;MPC&#39;</span>

<span class="ne">AssertionError</span>: Model for MPC was not setup. After the complete model creation call model.setup().
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
    <span class="s2">&quot;state_discretization&quot;</span><span class="p">:</span> <span class="s2">&quot;collocation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;radau&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_deg&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;collocation_ni&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;store_full_solution&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Use MA27 linear solver in ipopt for faster calculations:</span>
    <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">62</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="p">}</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id17">
<h3>Objective<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">distance_cost</span> <span class="o">=</span> <span class="n">casadi</span><span class="o">.</span><span class="n">bilin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">inverted_pendulum_lin</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">cat</span> <span class="o">-</span> <span class="n">xss</span><span class="p">)</span>
<span class="n">terminal_cost</span> <span class="o">=</span> <span class="n">distance_cost</span>
<span class="n">stage_cost</span> <span class="o">=</span> <span class="n">distance_cost</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terminal_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">terminal_cost</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">stage_cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>stage_cost=SX((((100*theta)*theta)+sq(dtheta)))
terminal_cost=SX((((100*theta)*theta)+sq(dtheta)))
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">63</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terminal_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">terminal_cost</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">stage_cost</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id18">
<h3>Constraints<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lower and upper bounds of the input</span>
<span class="n">u_max</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u_max</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_max</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">65</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># lower and upper bounds of the input</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">u_max</span> <span class="o">=</span> <span class="mi">3</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u_max</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_max</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id19">
<h3>Setup<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">66</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id20">
<h3>Simulation<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">67</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_lin_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">68</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_inverted_pendulum_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id21">
<h3>Evaluation<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MPCController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpc</span><span class="p">:</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">observation</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">70</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">71</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;show_video&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">72</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_inverted_pendulum_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id22">
<h2>Exercise<a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Design an MPC Controller for the non-linear inverted pendulum system for two different cases:</p>
<ol class="arabic simple">
<li><p>Cart at origin and upright Pendulm: Set the reference for the cart position to the origin.</p></li>
<li><p>Pendulum Swing-up: Set the initial angle to to <span class="math notranslate nohighlight">\(-\pi\)</span> i.e. start with the pendulum at the bottom.</p></li>
<li><p>Same as 2 but set the reference for the cart position to the origin.</p></li>
<li><p>Make the pendulum rotate as fast as possible.</p></li>
</ol>
</li>
</ul>
<blockquote>
<div><p><strong>Note 1</strong> Use the following to create the environment with initial angle set to -np.pi and cutoff angle to np.inf for second &gt; case.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span><span class="n">cutoff_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">initial_angle</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<blockquote>
<div><p><strong>Note 2</strong>: You can access the inverted pendulums kinetic, respectively potential, energy using
<code class="docutils literal notranslate"><span class="pre">inverted_pendulum.aux[&quot;E_kinetic&quot;]</span></code>, respectively <code class="docutils literal notranslate"><span class="pre">inverted_pendulum.aux[&quot;E_potential&quot;]</span></code></p>
</div></blockquote>
</section>
<section id="id23">
<h2>Solution<a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h2>
<section id="swing-up">
<h3>Swing-up<a class="headerlink" href="#swing-up" title="Permalink to this heading">#</a></h3>
<section id="id24">
<h4>Controller<a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">inverted_pendulum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">73</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">(</span><span class="n">inverted_pendulum</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/controller/_mpc.py:146,</span> in <span class="ni">MPC.__init__</span><span class="nt">(self, model, settings)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span><span class="n">do_mpc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">LinearModel</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MPCSettings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span>     <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<span class="ne">--&gt; </span><span class="mi">146</span>     <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Model for MPC was not setup. After the complete model creation call model.setup().&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">MPCData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;MPC&#39;</span>

<span class="ne">AssertionError</span>: Model for MPC was not setup. After the complete model creation call model.setup().
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
    <span class="s2">&quot;state_discretization&quot;</span><span class="p">:</span> <span class="s2">&quot;collocation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_type&quot;</span><span class="p">:</span> <span class="s2">&quot;radau&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collocation_deg&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;collocation_ni&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;store_full_solution&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Use MA27 linear solver in ipopt for faster calculations:</span>
    <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">74</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mpc_params</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="s2">&quot;n_horizon&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="s2">&quot;t_step&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="s2">&quot;nlpsol_opts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipopt.linear_solver&quot;</span><span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">},</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="p">}</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_params</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id25">
<h4>Objective<a class="headerlink" href="#id25" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_cost</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;E_kinetic&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;E_potential&quot;</span><span class="p">]</span>
<span class="n">terminal_cost</span> <span class="o">=</span> <span class="n">energy_cost</span>
<span class="n">stage_cost</span> <span class="o">=</span> <span class="n">energy_cost</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terminal_cost</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">mterm</span><span class="o">=</span><span class="n">terminal_cost</span><span class="p">,</span> <span class="n">lterm</span><span class="o">=</span><span class="n">stage_cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">Exception</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/casadi/tools/structure3.py:433,</span> in <span class="ni">Structure.traverseByPowerIndex</span><span class="nt">(self, powerIndex, canonicalIndex, dispatcher, payload)</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span>   <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">433</span>     <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know what to do with this: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">434</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="ne">Exception</span>: I don&#39;t know what to do with this: 0

<span class="n">The</span> <span class="n">above</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">the</span> <span class="n">direct</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">exception</span><span class="p">:</span>

<span class="ne">Exception</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">75</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">energy_cost</span> <span class="o">=</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;E_kinetic&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">inverted_pendulum</span><span class="o">.</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;E_potential&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">terminal_cost</span> <span class="o">=</span> <span class="n">energy_cost</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">stage_cost</span> <span class="o">=</span> <span class="n">energy_cost</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_model.py:468,</span> in <span class="ni">Model.aux</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">436</span> <span class="nd">@property</span>
<span class="g g-Whitespace">    </span><span class="mi">437</span> <span class="k">def</span> <span class="nf">aux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">438</span><span class="w">     </span><span class="sd">&quot;&quot;&quot; Auxiliary expressions.</span>
<span class="g g-Whitespace">    </span><span class="mi">439</span><span class="sd">         CasADi symbolic structure, can be indexed with user-defined variable names.</span>
<span class="g g-Whitespace">    </span><span class="mi">440</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">466</span><span class="sd">             assertion: Cannot set aux directly Use set_expression instead.</span>
<span class="g g-Whitespace">    </span><span class="mi">467</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">468</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getvar</span><span class="p">(</span><span class="s1">&#39;_aux_expression&#39;</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_model.py:201,</span> in <span class="ni">Model._getvar</span><span class="nt">(self, var_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span> <span class="n">sym_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s1">&#39;_aux_expression&#39;</span><span class="p">:</span>  <span class="c1"># or possibly &#39;_aux, depending on what is called in the getter</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span>     <span class="c1"># create the required dict from what is currently a </span>
<span class="ne">--&gt; </span><span class="mi">201</span>     <span class="n">sym_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:[</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sym_dict</span><span class="p">],</span> 
<span class="g g-Whitespace">    </span><span class="mi">202</span>                 <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">expr</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sym_dict</span><span class="p">]}</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="c1"># We use the same method as in setup to create symbolic structures from these dicts</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="n">sym_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert2struct</span><span class="p">(</span><span class="n">sym_dict</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/do_mpc/model/_model.py:201,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span> <span class="n">sym_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s1">&#39;_aux_expression&#39;</span><span class="p">:</span>  <span class="c1"># or possibly &#39;_aux, depending on what is called in the getter</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span>     <span class="c1"># create the required dict from what is currently a </span>
<span class="ne">--&gt; </span><span class="mi">201</span>     <span class="n">sym_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:[</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sym_dict</span><span class="p">],</span> 
<span class="g g-Whitespace">    </span><span class="mi">202</span>                 <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">expr</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sym_dict</span><span class="p">]}</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="c1"># We use the same method as in setup to create symbolic structures from these dicts</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span> <span class="n">sym_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert2struct</span><span class="p">(</span><span class="n">sym_dict</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/casadi/tools/structure3.py:123,</span> in <span class="ni">properGetitem.&lt;locals&gt;.proper</span><span class="nt">(self, mbt, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mbt</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">122</span>   <span class="n">mbt</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbt</span><span class="p">,)</span>
<span class="ne">--&gt; </span><span class="mi">123</span> <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mbt</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/casadi/tools/structure3.py:634,</span> in <span class="ni">MasterGettable.__getitem__</span><span class="nt">(self, powerIndex)</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span> <span class="nd">@properGetitem</span>
<span class="g g-Whitespace">    </span><span class="mi">633</span> <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">powerIndex</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">634</span>   <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">traverseByPowerIndex</span><span class="p">(</span><span class="n">powerIndex</span><span class="p">,</span><span class="n">dispatcher</span><span class="o">=</span><span class="n">GetterDispatcher</span><span class="p">(</span><span class="n">struct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">struct</span><span class="p">,</span><span class="n">master</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span><span class="n">priority_object_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_object_map</span><span class="p">))</span>

<span class="nn">File /tmp/code/.venv/lib/python3.11/site-packages/casadi/tools/structure3.py:435,</span> in <span class="ni">Structure.traverseByPowerIndex</span><span class="nt">(self, powerIndex, canonicalIndex, dispatcher, payload)</span>
<span class="g g-Whitespace">    </span><span class="mi">433</span>     <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;I don&#39;t know what to do with this: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">434</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">435</span>   <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error occured in struct context with powerIndex </span><span class="si">%s</span><span class="s2">, at canonicalIndex </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">powerIndex</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">canonicalIndex</span><span class="p">)))</span> <span class="kn">from</span> <span class="nn">e</span>

<span class="nn">Exception: Error occured</span> in <span class="ni">struct context with powerIndex (0,), at canonicalIndex </span><span class="nt">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">76</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">force_penalty</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">mpc</span><span class="o">.</span><span class="n">set_rterm</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force_penalty</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id26">
<h4>Constraints<a class="headerlink" href="#id26" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lower and upper bounds of the position</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_max</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_max</span>
<span class="c1"># lower and upper bounds of the input</span>
<span class="n">u_max</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u_max</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_u&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_max</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">77</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># lower and upper bounds of the position</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">x_max</span> <span class="o">=</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_max</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mpc</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_max</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># lower and upper bounds of the input</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id27">
<h4>Setup<a class="headerlink" href="#id27" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">78</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id28">
<h4>Simulation<a class="headerlink" href="#id28" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
<span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">79</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">inverted_pendulum_simulator</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;mpc&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_full_inverted_pendulum_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="id29">
<h4>Evaluation<a class="headerlink" href="#id29" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MPCController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpc</span><span class="p">:</span> <span class="n">do_mpc</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">MPC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span> <span class="o">=</span> <span class="n">mpc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">reset_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc</span><span class="o">.</span><span class="n">set_initial_guess</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mpc</span><span class="o">.</span><span class="n">make_step</span><span class="p">(</span><span class="n">observation</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span>
    <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span>
    <span class="n">cutoff_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
    <span class="n">initial_angle</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">82</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">env</span> <span class="o">=</span> <span class="n">create_inverted_pendulum_environment</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">cutoff_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">initial_angle</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="n">mpc</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">results</span> <span class="o">=</span> <span class="n">simulate_environment</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span> <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;create_inverted_pendulum_environment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">83</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_video</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">env</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;show_video&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">84</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">animate_full_inverted_pendulum_simulation</span><span class="p">(</span><span class="n">mpc</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;animate_full_inverted_pendulum_simulation&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="mpc-and-alphazero">
<h1>MPC and AlphaZero<a class="headerlink" href="#mpc-and-alphazero" title="Permalink to this heading">#</a></h1>
<p>AlphaZero is a computer program developed by artificial intelligence research company DeepMind to master the games of chess, shogi and go.</p>
<p>It is built from three core pieces:</p>
<ul class="simple">
<li><p>Value Function (Neural Network) to estimate the optimal cost-to-go for any given state.</p></li>
<li><p>Policy (Neural Network) to determine the action to take at a given state.</p></li>
<li><p>Monte Carlo Tree Search to simulate and search for the best plan.</p></li>
</ul>
<div>
<figure style="float: left; width: 60%;">
    <img src="_static/images/30_alphazero_online_play.png" width="100%"/>
</figure>
<div style="float: right; width: 30%;">
Illustration of an on-line player such as the one used in AlphaGo,
AlphaZero, and Tesauros backgammon program. At a given position,
it generates a lookahead tree of multiple moves up to some depth, then runs
the off-line obtained player for some more moves, and evaluates the effect of the
remaining moves by using the position evaluator of the off-line player.
</div>
</div><p>In AlphaZero, the policy and value networks are trained off-line and an approximate version of the fundamental DP algorithm of policy iteration. A separate on-line player is used to select moves, based on multistep lookahead minimization and a terminal position evaluator that was trained using experience with the off-line player.</p>
<p>This approach performs better than using the off-line policy directly because of the long lookahead minimization, which corrects for the inevitable imperfections of the neural network-trained off-line
player, and position evaluator/terminal cost approximation.</p>
<p>In model predictive control (MPC), there is no off-line training and we use the systems model for the on-line rollout. The control interval is equivalent to the number of steps in lookahead minimization, while the prediction interval is equivalent to the total number of steps in lookahead minimization and truncated rollout.</p>
<section id="monte-carlo-tree-search">
<h2>Monte Carlo Tree Search<a class="headerlink" href="#monte-carlo-tree-search" title="Permalink to this heading">#</a></h2>
<p>Monte Carlo Tree Search (MCTS) is a heuristic search algorithm which uses stochastic simulations for decision processes, most notably those employed in software that plays board games. In that context MCTS is used to solve the game tree.</p>
<p>MCTS was combined with neural networks in 2016 and has been used in multiple board games like Chess, Shogi, Checkers, Backgammon, Contract Bridge, Go, Scrabble, and Clobber as well as in turn-based-strategy video games (such as Total War: Rome IIs implementation in the high level campaign AI).</p>
<p>The method especially took off due its effectiveness in computer Go and is still being used in DeepMinds AlphaGoZero the most advanced Go AI to date.</p>
<p>MCTS consists of 4 steps that are repeated until some condition is met:</p>
<ol class="arabic simple">
<li><p><strong>Selection</strong>: The selection phase traverses the tree level by level, each time
selecting a node based on stored statistics like number of visits
or total reward. The rule by which the algorithm selects is called the tree policy.
Selection stops when a node is reached that is not fully explored yet, i.e.
not all possible moves have been expanded to new nodes yet.</p></li>
<li><p><strong>Expansion</strong>: The expansion step consists of adding one or multiple new
child nodes to the final selected node.</p></li>
</ol>
<ol class="arabic simple" start="3">
<li><p><strong>Rollout</strong>: A rollout is initiated from each of these added nodes.
Depending on the mean depth of the tree, rollout is done until the end of the game or
as deep as possible before performing an evaluation. When dealing with
terminal states in games the evaluation is done based on the win condition
and usually yields 0 (loss), 0.5 (draw) or 1 (win).
In the original algorithm the rollout is performed at random, but in general
the so-called default policy can be enhanced by heuristics. For example,
in the case of AlphaGoZero the rollout step was completely replaced by a
neural network evaluation function.</p></li>
<li><p><strong>Backup</strong>: The outcome of the rollout step is backed up to the nodes involved
in the selection phase by updating their respective statistics</p></li>
</ol>
<figure>
    <img src="_static/images/30_monte_carlo_tree_search.svg" width="100%"/>
</figure></section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p>Planning plays an important role in control, decision making and reinforcement learning.</p></li>
<li><p>Optimal Control is the branch of Control Theory concerned with optimizing a cost function through the use of open-loop planning.</p></li>
<li><p>The Linear Quadratic Regulator (LQR) is an optimal feedback control law that optimizes a quadratic cost function for LTI systems.</p></li>
<li><p>Model Predictive Control (MPC) is a control scheme that uses planning in a receding horizon to determine the best action to take at each time step.</p></li>
<li><p>MPC uses the systems model for the rollout and can approached in many different ways such as iLQR and DDP.</p></li>
<li><p>AlphaZero uses off-line learning and on-line planning to tackle different types of games. Unlike MPC it uses neural networks to determine the next best action and to approximate the cost-to-go.</p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="#slotine_applied_1991-back"><span class="xref myst"><b id="slotine_applied_1991">[Slotine 1991]</b></span></a> <a class="reference external" href="https://www.academia.edu/download/33582713/Applied_Nonlinear_Control_Slotine.pdf">Applied nonlinear control.</a> Slotine, Jean-Jacques E., and Weiping Li. Vol. 199, no. 1. Englewood Cliffs, NJ: Prentice hall. 1991.</p></li>
<li><p><a class="reference internal" href="#grune_nonlinear_2017-back"><span class="xref myst"><b id="grune_nonlinear_2017">[Lars Nonlinear 2017]</b></span></a> <a class="reference external" href="https://link.springer.com/chapter/10.1007/978-3-319-46024-6_3">Nonlinear model predictive control.</a> Grne, Lars, Jrgen Pannek, Lars Grne, and Jrgen Pannek. Springer International Publishing, 2017.</p></li>
<li><p><a class="reference internal" href="#biral_notes_2016-back"><span class="xref myst"><b id="biral_notes_2016">[Biral Notes 2016]</b></span></a> <a class="reference external" href="https://www.jstage.jst.go.jp/article/ieejjia/5/2/5_154/_article/-char/ja/">Notes on numerical methods for solving optimal control problems.</a> Biral, Francesco, Enrico Bertolazzi, and Paolo Bosetti. IEEJ Journal of Industry Applications 5, no. 2 (2016): 154-166.</p></li>
<li><p><a class="reference internal" href="#bertsekas_lessons_2022-back"><span class="xref myst"><b id="bertsekas_lessons_2022">[Bertsektas, Dimitri P, 2022]</b></span></a> <a class="reference external" href="http://web.mit.edu/dimitrib/www/LessonsfromAlphazero.pdf">Lessons from AlphaZero for Optimal, Model Predictive, and Adaptive Control</a> - Dimitri P. Bertsektas. 2022.</p></li>
<li><p><a class="reference internal" href="#spencer_optimal_2023-back"><span class="xref myst"><b id="spencer_optimal_2023">[Spencer et al. 2023]</b></span></a> <a class="reference external" href="https://stanfordasl.github.io/aa203/sp2223/">AA 203: Optimal and Learning-Based Control.</a> Optimal control solution techniques for systems with known and unknown dynamics. 2023.</p></li>
<li><p><a class="reference internal" href="#tedrake_underactuated_2023-back"><span class="xref myst"><b id="tedrake_underactuated_2023">[Russ Tedrake, 2023]</b></span></a> <a class="reference external" href="http://underactuated.mit.edu/index.html">Underactuated Robotics: Algorithms for Walking, Running, Swimming, Flying, and Manipulation (Course Notes for MIT 6.832)</a> Russ Tedrake. Downloaded on 24.10.2023.</p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "aai-institute/tfl-training-machine-learning-control",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="nb_10_Introduction.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction</p>
      </div>
    </a>
    <a class="right-next"
       href="nb_40_RecentDevelopmentsInControl.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Introduction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#planning">Planning</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#state-transition-systems">State-Transition Systems</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plans">Plans</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-control">Optimal Control</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-time">Continuous-time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-time">Discrete-time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-horizon">Finite Horizon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#infinite-horizon">Infinite Horizon</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-the-cost-function">Choosing the cost function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#systems">Systems</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mass-spring-damper-model">Mass-Spring-Damper Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-space-matrices">State-Space Matrices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-states-and-control-inputs">Model, States and Control inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretization">Discretization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inverted-pendulum-model">Inverted Pendulum Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linearized-model">Linearized Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">State-Space Matrices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Model, States and Control inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#auxiliary-expressions">Auxiliary Expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#model-setup">Model Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Discretization</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-linear-model">Non-Linear Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Model, States and Control inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ode">ODE</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Auxiliary Expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Model Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helpers">Helpers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulators">Simulators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-programming">Dynamic Programming</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dp-algorithm">DP Algorithm</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">Solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-quadratic-regulator">Linear Quadratic Regulator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mass-spring-damper">Mass-Spring-Damper</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation">SImulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inverted-pendulum">Inverted Pendulum</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#model-predictive-control">Model Predictive Control</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-linear-quadratic-regulator">Iterative Linear Quadratic Regulator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#differential-dynamic-programming">Differential Dynamic Programming</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Mass-Spring-Damper</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#controller">Controller</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#objective">Objective</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#constraints">Constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#swing-up">Swing-up</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Controller</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Objective</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Simulation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Evaluation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#mpc-and-alphazero">MPC and AlphaZero</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monte-carlo-tree-search">Monte Carlo Tree Search</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By appliedAI TransferLab
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>